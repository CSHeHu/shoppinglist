services:
  mongo:
    image: mongo:6
    container_name: shoppinglist-mongo
    volumes:
      - mongo-data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGODB_DB: ${MONGODB_DB}
      API_SERVER: ${API_SERVER}
    command: ["mongod"]
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 12

  mongo-init:
    image: mongo:6
    container_name: shoppinglist-mongo-init
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_APP_USER: ${MONGO_APP_USER}
      MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD}
      MONGODB_DB: ${MONGODB_DB}
      USER_DB_NAME: ${USER_DB_NAME}
      USER_DB_USER: ${USER_DB_USER}
      USER_DB_PASSWORD: ${USER_DB_PASSWORD}
    entrypoint:
    - mongosh
    - --host
    - shoppinglist-mongo
    - -u
    - "${MONGO_INITDB_ROOT_USERNAME}"
    - -p
    - "${MONGO_INITDB_ROOT_PASSWORD}"
    - --authenticationDatabase
    - admin
    - --eval
    - |
        print("Creating app DB user");
        let appDb = db.getSiblingDB('${MONGODB_DB}');
        if (!appDb.getUser('${MONGO_APP_USER}')) {
          appDb.createUser({
            user: '${MONGO_APP_USER}',
            pwd: '${MONGO_APP_PASSWORD}',
            roles: [{ role: 'readWrite', db: '${MONGODB_DB}' }]
          });
        }

        print("Creating user DB user");
        let userDb = db.getSiblingDB('${USER_DB_NAME}');
        if (!userDb.getUser('${USER_DB_USER}')) {
          userDb.createUser({
            user: '${USER_DB_USER}',
            pwd: '${USER_DB_PASSWORD}',
            roles: [{ role: 'readWrite', db: '${USER_DB_NAME}' }]
          });
        }
    restart: 'no'
    networks:
      - backend

  shoppinglist:
    build:
      context: .
      dockerfile: Dockerfile.shoppinglistapp
    container_name: shoppinglist-app
    depends_on:
      mongo:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: ${NODE_ENV}
      MONGO_APP_USER: ${MONGO_APP_USER}
      MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD}
      MONGODB_DB: ${MONGODB_DB}
      MONGODB_HOST: ${MONGODB_HOST} 
      API_SERVER: ${API_SERVER}
      SESSION_SECRET: ${SESSION_SECRET}
      ROOT_EMAIL: ${ROOT_EMAIL}
      ROOT_PASSWORD: ${ROOT_PASSWORD}
    networks:
      - backend



  nginx:
    image: nginx:stable
    container_name: shoppinglist-nginx
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - shoppinglist
    volumes:
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certs:/etc/nginx/certs:ro
    networks:
      - default
      - backend

  admin_user-populate:
    build:
      context: .
      dockerfile: Dockerfile.populate
    container_name: shoppinglist-mongo-populate_admin_user
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    environment:
      MONGO_HOST: shoppinglist-mongo
      MONGO_PORT: 27017
      USER_DB_NAME: ${USER_DB_NAME}
      USER_DB_USER: ${USER_DB_USER}
      USER_DB_PASSWORD: ${USER_DB_PASSWORD}
      ROOT_EMAIL: ${ROOT_EMAIL}
      ROOT_PASSWORD: ${ROOT_PASSWORD}
    restart: "no"
    networks:
      - backend

volumes:
  mongo-data:
  
networks:
  backend:
    internal: true
  default:
    driver: bridge



